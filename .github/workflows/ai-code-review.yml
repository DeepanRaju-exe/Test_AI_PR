name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review
        env:
          OPENAI_API_KEY: ${{ secrets.GIT_PR_REVIEW }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          DIFF="${{ steps.diff.outputs.diff }}"
          
          # Truncate diff if too large (OpenAI has token limits)
          DIFF_LENGTH=${#DIFF}
          if [ $DIFF_LENGTH -gt 50000 ]; then
            DIFF="${DIFF:0:50000}... (diff truncated due to size)"
          fi
          
          # Create the review request
          REVIEW_PROMPT="Please review this code diff and provide constructive feedback. Focus on:
          - Potential bugs or errors
          - Code quality and best practices
          - Security issues
          - Performance concerns
          - Readability and maintainability
          
          Here's the diff:
          \`\`\`
          $DIFF
          \`\`\`"
          
          # Call OpenAI API
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o\",
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$REVIEW_PROMPT" | jq -Rs .)}],
              \"temperature\": 0.3,
              \"max_tokens\": 2000
            }")
          
          # Extract the review content
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          # Post as PR comment
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments \
            -d "{\"body\": \"## ðŸ¤– AI Code Review\n\n$REVIEW\n\n---\n*This is an automated review and is non-blocking.*\"}"
